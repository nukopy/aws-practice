# DynamoDB まとめ

以下の記事を写経

- [Future Tech Blog：【入門】私を苦しめた DynamoDB](https://future-architect.github.io/articles/20200818/)

## ポイント

- DB = RDBMS という固定概念を取り除くこと
- KVS（NoSQL）の概念の理解
- CRUD 操作（特に Python）

## DynamoDB とは

公式ドキュメントによると，

> Amazon DynamoDB は、規模に関係なく数ミリ秒台のパフォーマンスを実現する、key-value およびドキュメントデータベースです。完全マネージド型マルチリージョン、マルチマスターで耐久性があるデータベースで、セキュリティ、バックアップおよび復元と、インターネット規模のアプリケーション用のメモリ内キャッシュが組み込まれています。DynamoDB は、1 日に 10 兆件以上のリクエストを処理することができ、毎秒 2,000 万件を超えるリクエストをサポートします。

とのこと．とりあえずすごいと言うことはわかった．
ざっくりと，AWS が提供する key-value 型のハイパフォーマンス NoSQL フルマネージドサービスである．

## NoSQL とは

そもそも NoSQL とは何者でしょうか．次世代的な響きがしてカッコいいよね．
DynamoDB を触り始める以前，Yes/No の NoSQL だと思っていましたが，Not Only SQL の略称である．
NoSQL について Wikipedia から冒頭の説明文を引用してみる．

> NoSQL（一般に “Not only SQL” と解釈される）とは，関係データベース管理システム（RDBMS）以外のデータベース管理システムを指すおおまかな分類語である．関係データベースを杓子定規に適用してきた長い歴史を打破し，それ以外の構造のデータベースの利用・発展を促進させようとする運動の標語としての意味合いを持つ．

つまり，RDBMS 以外の DB システムを指す大まかな定義の単語のようだ．
一口に NoSQL といってもデータ形式の格納方式の違いで様々なタイプの NoSQL が存在する．
大きくは下記 3 つに分類される．

```txt
1. KVS (Key-Value-Store)
2. ドキュメント DB
3. グラフ DB
```

DynamoDB は NoSQL の内，KVS に該当する．

## RDBMS との志向の違い

RDBMS と NoSQL は異なる志向を持つ．

RDBMS は ACID（Atomicity，Consistency，Isolation，Durability）という特性で語られる．
ざっくりと，トランザクションにおいて持つべき 4 つの特性（原子性/一貫性/独立性/永続性）を表現したもの．

それに対して，NoSQL は BASE（Basically Available，Soft-State，Eventual Consistency）特性という特徴で語られる．
ざっくりと，「基本的には常に利用可能で，常に整合性を保っている必要はなく，一時的に一貫性のない状態を許容して，結果的には整合性が取れている状態に至る（結果整合性）」 というもの．ACID とは対照的に，可用性や性能を重視した分散システムの特性である．

ということは，「DynamoDB でトランザクション制御はできないの？」と考える人もいると思う．それに関しては後述する．

余談だが，ACID(酸）に対して，BASE(塩基）とはめちゃくちゃイケてるネーミング．

## DynamoDB の特徴

- 高可用性
  - DynamoDB では高可用性を重視している．
  - 具体的には 3 つの AZ（Availability Zone）でレプリケーションを持っている．そのため AZ に問題が起きても，他の AZ が機能するため耐久性・信頼性が担保されている．
- フルマネージド
  - データ容量の増加に応じたディスクやノードの増設作業をはじめ，メンテナンスが不要．テーブルを自動的にスケールアップ/ダウンして容量を調整し，パフォーマンスを維持してくれる．
- SQL クエリを直接はサポートしていない
  - NoSQL とだけあって SQL を直接サポートされていない．そのためテーブルの結合も行えない（DQL など，SQL ライクに書けるラッパーは存在する）．シンプルな CRUD に対しては非常に有効だが，複雑なものが不得意なのかもしれない．

## DynamoDB を触る上で抑えておくべきポイント

- pet-shop テーブル
  - pet_id
  - shop_id
  - kind：dog, cat
  - birth
  <!-- - detail：入れ子の JSON -->
  - description

### 主要概念

DynamoDB には，いくつかの独自概念が登場する．
イメージ的に，RDBMS の既存概念と似ているものがあるので表にしてみた．

| DynamoDB | RDBMS |
| Table | Table |
| Item | Row |
| Attributes | Column |
| Partition Key | Primary Key |
| Sort Key | Key 指定する場合は Primary Key を構成する一部になる |

ポイントは，Item は正規化の必要が無い点．

つまり，異なる Item で同名の Attribute を持つ必要はない．また，`detail` のように Attribute にネストしたデータ構造を持たせることも可能．

Table，Item，Attributes に関しては，RDBMS と同じような概念がため，ある程度理解が出来ると思う．

### パーティションキーとソートキー

DynamoDB を触る上で絶対に抑えて置かなければならない概念に，パーティションキー（別称：ハッシュキー）とソートキー（別称：レンジキー）が挙げられる．DynamoDB では，パーティションーキー，もしくはパーティションキーとソートキーによってユニークな Item を表現する．

DynamoDB では，Item を内部的にパーティションごとに分散して保持している．
パーティションキーは内部的にハッシュ関数が実行され，ハッシュ文字列が生成される．
生成されたハッシュ文字列をもとに，Item の格納場所が決まる．そのためパーティションキーは必須となる．
ソートキーでは範囲指定やソートが可能（shop_id をソートキーにするべきかは見逃してください）．
そのため，ソートキー以外の Attribute での Order by は不可能である．
ソートキーの設定は必須ではない．

### Secondary Index

先程パーティションキーとソートキーについて説明をしたが，Secondary Index はプライマリキー以外の属性を使用する際に登場する概念である．Secondary Index には，LSI と GSI という 2 つの概念が存在する．

#### LSI

Local Secondary Index の頭文字を取っている．LSI は，ソートキー以外での絞り込みを行うキーを設定できるものである．

例でいうと，birth を LSI に設定した場合，pet_id + birth のような検索ができるようになる．
注意点として，LSI は既存のテーブルに追加・削除はできない．テーブル作成時に定義するようにしよう．

#### GSI

Grobal Secondary Index の頭文字を取っている．GSIは，パーティションキーを別途設定できるものである．

例でいうと，kind で dog の Itemを取得したい際に，kind を GSI に設定することで検索が容易にできるようになる．
LSIと異なり，既存のテーブルに追加・削除できる．
しかし，GSIを 1 つ定義すると，テーブルが 1 つ増えるのと同等のコスト増しになる．

### DynamoDBでトランザクション制御は可能なのか

可能．詳細については公式 Docs を参照（[Amazon DynamoDB 取引: 仕組み](https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/transaction-apis.html)）．
単一の AWS アカウントおよび領域内の複数のテーブルにわたって，ACID を提供している．
ここでは DynamoDB におけるトランザクション制御の特徴を挙げる．

- DynamoDBにおけるトランザクション制御についての特徴
  - 複数テーブルに対して制御できる
  - トランザクションに含められるのは 25 件まで(記事執筆時点(2020/08/17))
  - テーブルのロックはされない
  - もし，トランザクション中に他操作が入った場合，トランザクションは中止されて例外が返ってくる．
  - 同一 Item に対して操作はできない
  - 全ての商用リージョンで利用可能

## DynamoDBを触るうえでの注意点

最後に，実際に触ってみて「独特だなぁ」と感じた部分について記載する．

- パーティションキーやソートキーに空文字は入れられない
- タイムスタンプの概念が存在しないので，文字列での登録が必要（日付型自体はサポートされている．ソートキーとして定義した場合，日付のソート等は可能．詳しいデータ型に関しては[こちら](https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html)を参照（サポートされているデータ（型）の種類）．
- テーブルの結合ができない
- 基本的に API 経由で触る
- AWS のクレデンシャル情報で認証

---

## 各種 tips

### DynamoDB データ更新 UpdateExpression

- [DynamoDB でデータを更新する際に使う UpdateExpression について一通りまとめてみた](https://dev.classmethod.jp/articles/dynamodb-update-expression-actions/)

---

## boto3 で DynamoDB を扱う

### Batch writing

一度に大量のデータをロードする場合は，`DynamoDB.Table.batch_writer()` を利用することで，処理の高速化とサービスへの書き込みリクエスト数の削減を両立させることができる．

このメソッドは，バッチでのアイテムのバッファリングと送信を自動的に処理するバッチライターオブジェクトへのハンドルを返す．さらに，バッチライターは未処理のアイテムも自動的に処理し，必要に応じて再送信する．

必要なのは，追加したいアイテムには `put_item` を，削除したいアイテムには `delete_item` をコールするだけである．

---

## DynamoDB ストリーム と AWS Lambda のトリガー

- 用語
  - DynamoDB ストリーム

- トピック
  - チュートリアル: DynamoDB ストリーム および Lambdaを使用して新しい項目を処理する
  - Lambda を使用する際のベストプラクティス

Amazon DynamoDB は AWS Lambda と統合されているため，「**トリガー**」（DynamoDB ストリーム 内のイベントに自動的に応答するコード）を作成できる．トリガーを使用すると，DynamoDB テーブル内のデータ変更に対応するアプリケーションを構築できる．

テーブルで DynamoDB ストリーム を有効にした場合，書き込む AWS Lambda 関数にストリームの Amazon リソースネーム (ARN) を関連付けることができる．テーブルの項目が変更されるとすぐに，新しいレコードがテーブルのストリームに表示される．AWS Lambda はストリームをポーリングし，新しいストリームレコードを検出すると，Lambda 関数を同期的に呼び出す．

Lambda 関数は，通知の送信やワークフローの開始など，指定したアクションを実行できる．

例えば，各ストリームレコードを Amazon Simple Storage Service（Amazon S3）などの永続的ストレージにコピーしたり，書き込みアクティビティの永続的な監査証跡をテーブルに作成したりする Lambda 関数を記述できる．

または，`GameScores` テーブルに書き込みを行うモバイルゲームアプリがあるとする．`TopScore` テーブルの `GameScores` 属性が更新されるたびに，対応するストリームレコードがテーブルのストリームに書き込まれる．その後，このイベントによって Lambda 関数をトリガーし，ソーシャルメディアネットワークにおめでとうメッセージを投稿できる（この関数は，`GameScores` の更新でないストリームレコードや，`TopScore` 属性を変更しないストリームレコードを無視する）．

### チュートリアル: DynamoDB ストリーム および Lambdaを使用して新しい項目を処理する

- ステップ 1: ストリームが有効になった DynamoDB テーブルを作成する
- ステップ 2: Lambda 実行ロールを作成する
- ステップ 3: Amazon SNS トピックを作成する
- ステップ 4: Lambda 関数を作成してテストする
- ステップ 5: トリガーを作成してテストする

---
