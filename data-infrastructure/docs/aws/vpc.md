# VPC：Virtual Private Cloud

- VPC の基本概念
- AWS のネットワーク基礎知識
- AWS のネットワーク系各種コンポーネント
  - インターネットゲートウェイ
  - NAT ゲートウェイ
  - ルートテーブル
  - セキュリティグループ
  - ネットワーク ACL
  - VPC エンドポイント（VPC エンドポイントサービス）
  - ENI（Elastic Network Interface）
    - NIC（ネットワークインターフェースカード）の仮想版
  - VPC ヒアリング
  - Direct Connect & VPN

## AWS の基本用語

- アベイラビリティゾーン，AZ
  - データセンターの最小単位
  - 正確には複数のデータセンターを持つ AZ もあるが，ユーザが意識する必要はない
- リージョン，region
  - AZ を束ねた地域
  - 東京リージョンは 3 つ（4 つ）

構成としては以下の通り：

- region 1
  - AZ 1
  - AZ 2
  - AZ 3
- region 2
  - AZ 4（1 つのリージョンに 1 つの AZ である場合もある）
- region 3
  - AZ 5
  - AZ 6

## Amazon VPC：Amazon Virtual Private Cloud

- 公式 doc：[Amazon VPC とは？](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/what-is-amazon-vpc.html)

Amazon Virtual Private Cloud (Amazon VPC) を使用すると，定義した仮想ネットワーク内で AWS リソースを起動できる．仮想ネットワークは，ユーザ自身のデータセンターで運用されていた従来のネットワークによく似ているが．AWS のスケーラブルなインフラストラクチャを使用できるというメリットがある．

### Amazon VPC の概念

Amazon VPC は，Amazon EC2 のネットワーキングレイヤーである．

VPC の主な概念は次の通り：

- Virtual Private Cloud（VPC）
  - AWS アカウント専用の仮想ネットワーク
- サブネット
  - VPC の IP アドレスの範囲
- ルートテーブル
  - ネットワークトラフィックの経路を判断する際に使用される，「ルート」と呼ばれる一連のルール
- インターネットゲートウェイ
  - VPC 内のリソースとインターネット間の通信を可能にするために VPC にアタッチするゲートウェイ
- VPC エンドポイント
  - PrivateLink を使用してサポートされている AWS サービスや VPC エンドポイントサービスに VPC をプライベートに接続できる．インターネットゲートウェイ，NAT デバイス，VPN 接続，または AWS Direct Connect 接続は必要ない．VPC のインスタンスは，サービスのリソースと通信するためにパブリック IP アドレスを必要としません．VPC と他のサービス間のトラフィックは，Amazon ネットワークを離れない．詳細については，「VPC エンドポイント および VPC エンドポイントサービス (AWS PrivateLink)」を参照．

### Amazon VPC へのアクセス

次のインターフェイスのいずれかを使用して，VPC の作成，アクセス，管理を行うことができる．

- AWS マネジメントコンソール
  - VPC へのアクセスに使用するウェブインターフェイスを提供する
- AWS コマンドラインインターフェイス（AWS CLI）
  - Amazon VPC を含むさまざまな AWS のサービス用のコマンドが用意されており，Windows，Mac，および Linux でサポートされている
- AWS SDK
  - 言語固有の API を提供し，署名の計算，リクエストの再試行処理，エラー処理など，接続のさまざまな詳細を処理する
- クエリ API
  - HTTPS リクエストを使用して呼び出す低レベル API アクションを提供する
  - クエリ API の使用は，Amazon VPC の最も直接的なアクセス方法だが，リクエストに署名するハッシュの生成やエラー処理など，低レベルの詳細な作業をアプリケーションで処理する必要がある．詳細については，「Amazon EC2 API Reference」を参照．

## VPC とサブネット

- VPC
  - AWS 内部のネットワーク環境
  - AWS を作成するとデフォルト VPC が作られるが，これを直接使うことはない
- サブネット
  - AZ をまたげない

### VPC の quota

- 1 アカウントにつき，1 つリージョンに 5 つまで VPC の構築が可能

## ENI：Elastic Network Interface

- ENI，Elastic Network Interface
  - NIC（ネットワークインターフェースカード）の仮想版
  - [AWS のネットワークインターフェース「ENI」とは](https://business.ntt-east.co.jp/content/cloudsolution/column-14.html)

VPC を使えば，仮想的なプライベート環境に EC2 を使ってサーバを立ち上げることができる．
こうした環境において，VPC に対してネットワークインターフェースを追加する役割を担うのが ENI である．

ENI は，物理的な環境における NIC（Network Interface Card）のことである．
NIC の場合は，サーバに複数枚挿すことで，サーバが担う複数の役割に応じて IP アドレスを複数持たせたり，
異なるセグメント間で 1 台のサーバーを動作させたりすることができた．
ENI も仮想的な環境において NIC と同様のネットワーク設定ができるようになると考えてよい．
近年では，どこにいても働ける環境を提供する「テレワーク」の普及といった影響から，ネットワークに関する要求レベルは高度化している．NIC を活用して必要なネットワーク設定を行うことで，ユーザのニーズに応える必要がある．

仮想環境にあるとはいえ，EC2 上で構築する仮想インスタンスの実態は，物理的なサーバである．このため
設定できる IP アドレスの数には，選択するインスタンスに応じて制限がある点には注意が必要．
例えば，選択する仮想インスタンスのタイプが「`a1.medium`」であれば，ネットワークインターフェースの最大数は「2」であり，ネットワークインターフェース当たりの IPv4 アドレス，および IPv6 アドレスの数はそれぞれ「4」である．仮想インスタンスに設定したいネットワークインターフェース数や IP アドレス数も考慮に入れて，インスタンスタイプを選定するようにしよう．

### ENI が実現可能なこと

物理的な環境であれば，ネットワークインターフェースを増加させるためには，サーバに対して NIC を挿す必要があった．
AWS の場合は ENI に対して，IP アドレスの登録や MAC アドレスの登録，セキュリティグループの登録など，必要な設定を行うことによりネットワークインターフェースを作成し，これを仮想インスタンスに取り付けたり，取り外したりすることを全て Web ブラウザ上で実現することができる．ただし，仮想インスタンスには，デフォルトのネットワークインターフェース（eth0）があらかじめ取り付けられている．このネットワークインターフェースは，取り外すことはできないので注意が必要である．
まずは，仮想インスタンスに対するネットワーク設定は，デフォルトのネットワークインターフェースに対して行い，さらにネットワークインターフェースを追加する必要がある場合は，ENI を追加していけば良い．

### ENI のユースケース

- 管理者ネットワークの作成

ENI を追加して使う必要があるケースの代表的なものとしては，管理用ネットワークの作成が挙げられる．
ユーザからのアクセスは，デフォルトのネットワークインターフェースで受け付け，メンテナンス等の管理目的のアクセスは，ENI により追加したネットワークインターフェースで管理者用パソコンからのアクセスのみを受け付ける．
このように，ユーザからのアクセスと管理者からのアクセスを明確に区別することで，セキュリティレベルを強化することができる．

- ネットワークインターフェースの冗長化

そのほかにも，ENI を使ってネットワークインターフェースを追加することで，ネットワークインターフェースの冗長化を実現することもあるだろう．
稼働系のネットワークインターフェースに障害が発生した場合，待機系のインターフェースに切り替わるプログラムコードを動かしておくこともできる．こうした仕組みを実現することで，障害発生時に，プライベート IP アドレス，Elastic IP アドレス，MAC アドレスを待機系のネットワークインターフェースに引き継いで，ダウンタイムを最小化しながらサービスを継続することができる．

ENI には，さまざまなネットワーク設定をすることができる．設定できる内容の詳細は以下の通り．

- プライベート IPv4 アドレス（VPC のアドレス範囲内）の設定
- 固定 IP アドレス（Elastic IP アドレス）の設定
- IPv6 アドレスの設定
- セキュリティグループの設定
- MAC アドレスの管理
- ルーティング情報の設定

## ネットワーク ACL とセキュリティグループの違い

- [【図解/AWS】ネットワーク ACL とセキュリティグループの違いと優先度，復路の制御について〜](https://milestone-of-se.nesuke.com/sv-advanced/aws/network-acl-and-security-group/#:~:text=%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AB-,%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%20ACL%20%E3%81%A8%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E9%81%95%E3%81%84,%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AB%E3%82%BB%E3%83%83%E3%83%88%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82&text=%E5%9B%B3%E3%81%AB%E3%81%82%E3%82%8B%E9%80%9A%E3%82%8A%E3%80%81%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF,%E3%81%AE%E3%81%BF%E3%81%AB%E9%81%A9%E7%94%A8%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82)

ネットワーク ACL とセキュリティグループは，どちらも NW レベル（IP，TCP/UDP レベル）で通信を許可 or 拒否する仕組みである．この 2 つの違いや優先度を解説する．

- ネットワーク ACL は VPC 内のサブネットに適用される
- セキュリティグループは EC2 等のインスタンス（正確には ENI）にセットされます．以下の図ではその様子を表しています．ネットワーク ACL で制御されるタイミングを青丸，セキュリティグループで制御されるタイミングを赤丸で示しています．

### 補足：サブネットについて

TODO
